stages:
  - Quick tests
  - Build
  - Tests
  - Release
  - Deploy

Database diff test:
  stage: Quick tests
  script:
    - ./directory-db/diff.sh ci-once
    - ./txlog-db/diff.sh ci-once

Go go.mod tidy test:
  stage: Quick tests
  script:
    - cp go.mod go.mod.orig
    - /usr/local/go/bin/go mod tidy
    - diff go.mod.orig go.mod

Build:
  stage: Build
  script:
    - skaffold build

Go test:
  stage: Tests
  script:
    - /usr/local/go/bin/go test ./...

Release container images:
  stage: Release
  tags:
    - nlx-privileged
  script:
    - skaffold build --profile release
  only:
    - master
    - tags

.deploy:
  stage: Deploy
  tags:
    - nlx-privileged
  script:
    - skaffold run --profile release --profile deploy-${CI_ENVIRONMENT_NAME}

Deploy test:
  extends: .deploy
  environment:
    name: test
  only:
    - master
    - tags

# Deploy acceptance:
#   extends: .deploy
#   environment:
#     name: acc
#   only:
#     - tags

Deploy demo:
  extends: .deploy
  environment:
    name: demo
  when: manual
  only:
    - tags

# deploy_test:
#   stage: deploy
#   script:
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/unsafe-ca unsafe-ca=nlxio/unsafe-ca:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/certportal certportal=nlxio/certportal:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/docs docs=nlxio/docs:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/directory directory=nlxio/directory:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/directory-ui directory-ui=nlxio/directory-ui:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/monitor monitor=nlxio/monitor:${CI_COMMIT_SHA:0:8}"
#   environment:
#     name: test
#   only:
#   - master

# deploy_demo:
#   stage: deploy
#   when: manual
#   script:
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/unsafe-ca unsafe-ca=nlxio/unsafe-ca:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/certportal certportal=nlxio/certportal:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/docs docs=nlxio/docs:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/directory directory=nlxio/directory:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/directory-ui directory-ui=nlxio/directory-ui:${CI_COMMIT_SHA:0:8}"
#   - ssh console.nlx.io "/snap/bin/kubectl --namespace=${CI_ENVIRONMENT_NAME} set image deployment/monitor monitor=nlxio/monitor:${CI_COMMIT_SHA:0:8}"
#   environment:
#     name: demo
#   only:
#   - master
