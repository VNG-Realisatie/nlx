stages:
  - Tests
  - Build
  - Tools
  - Release
  - Deploy
  - Scan

Go go.mod tidy test:
  stage: Tests
  script:
    - cp go.mod go.mod.orig
    - /usr/local/go/bin/go mod download
    - /usr/local/go/bin/go mod tidy
    - diff go.mod.orig go.mod
  tags:
    - nlx
    - shell-executor
  except:
    - schedules

Go tests:
  stage: Tests
  script:
    - /usr/local/go/bin/go mod download
    - /usr/local/go/bin/go test ./... -coverprofile coverage.out
    - /usr/local/go/bin/go tool cover -html=coverage.out -o coverage.html
    - /usr/local/go/bin/go tool cover -func=coverage.out
  coverage: /total:\t+\(statements\)\t+([\d\.]+?%)/
  artifacts:
    expire_in: 1 month
    paths:
      - coverage.html
  tags:
    - nlx
    - shell-executor
  except:
    - schedules

Go linter:
  stage: Tests
  before_script:
   - export PATH=$PATH:/usr/local/go/bin
  script: 
    - golangci-lint run --new-from-rev $(git rev-parse origin/master)
  tags:
    - nlx
    - shell-executor
  except:
    - schedules
  
Directory-ui tests:
  image: node:10.16.0-alpine
  stage: Tests
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
    - node_modules/
  before_script:
    - cd directory-ui/
    - npm install
  script:
    - npm test -- --coverage
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  artifacts:
    expire_in: 1 month
    paths:
      - directory-ui/coverage
  tags:
    - nlx
    - docker-executor
  except:
    - schedules

Insight-ui tests:
  image: node:10.16.0-alpine
  stage: Tests
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
    - node_modules/
  before_script:
    - cd insight-ui/
    - npm install
  script:
    - npm test -- --coverage
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  artifacts:
    expire_in: 1 month
    paths:
      - insight-ui/coverage
  tags:
    - nlx
    - docker-executor
  except:
    - schedules

Txlog-ui tests:
  image: node:10.16.0-alpine
  stage: Tests
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
    - node_modules/
  before_script:
    - cd txlog-ui/
    - npm install
  script:
    - npm test -- --coverage
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  artifacts:
    expire_in: 1 month
    paths:
      - txlog-ui/coverage
  tags:
    - nlx
    - docker-executor

Database diff test:
  stage: Tests
  script:
    - ./directory-db/diff.sh ci-once
    - ./txlog-db/diff.sh ci-once
  tags:
    - nlx
    - shell-executor
  except:
    - schedules

Build:
  stage: Build
  script:
    - skaffold build
  except:
    - master
    - tags
    - schedules
  tags:
    - nlx
    - shell-executor

Run semantic release:
  image: node:10.16.0
  stage: Tools
  before_script:
  - npm ci
  script:
    - npx semantic-release
  only:
    - master
  when: manual
  tags:
    - nlx
    - docker-executor  
  except:
    - schedules

Release container images:
  stage: Release
  script:
    - skaffold build --profile release
  only:
    - master
    - tags
  tags:
    - nlx-privileged
    - shell-executor
  except:
    - schedules

.deploy:
  stage: Deploy
  script:
    - skaffold run --profile release --profile deploy-${CI_ENVIRONMENT_NAME}
  tags:
    - nlx-privileged
    - shell-executor
  except:
    - schedules

Deploy test:
  extends: .deploy
  before_script:
    - kubectl config use-context delta.k8s.nlx.io
  environment:
    name: test
  only:
    - master
  tags:
    - nlx-privileged
    - shell-executor

Deploy acceptance:
  extends: .deploy
  before_script:
    - kubectl config use-context delta.k8s.nlx.io
  environment:
    name: acc
  only:
    - tags
  tags:
    - nlx-privileged
    - shell-executor

Deploy demo:
  extends: .deploy
  before_script:
    - kubectl config use-context delta.k8s.nlx.io
  environment:
    name: demo
  only:
    - tags
  when: manual
  tags:
    - nlx-privileged
    - shell-executor

# Deploy preprod:
#   extends: .deploy
#   before_script:
#     - kubectl config use-context delta.k8s.nlx.io
#   environment:
#     name: preprod
#   when: manual
#   only:
#     - tags

# Deploy prod:
#   extends: .deploy
#   before_script:
#     - kubectl config use-context delta.k8s.nlx.io
#   environment:
#     name: prod
#   when: manual
#   only:
#     - tags

Docker tag latest:
  stage: Deploy
  script:
    - skaffold build --profile release | ./docker-tag-latest.awk
  only:
    - tags
  when: manual
  tags:
    - nlx-privileged
    - shell-executor
  except:
    - schedules

# Scan configuration based on
# the offical GitLab documentation and adjusted to be able to:
# - scan multiple images, based on images-to-scan.txt
# - transform the output files of the scans into one file named gl-container-scanning-report.json
# Via https://docs.gitlab.com/ee/user/application_security/container_scanning/#including-the-provided-template
Scan images:
  stage: Scan
  image: docker:stable
  tags:
    - docker
    - linux
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  services:
    - docker:dind
  variables:
    CLAIR_LOCAL_SCAN_VERSION: v2.0.8_fe9b059d930314b54c78f75afe265955faf4fdc1
    NO_PROXY: docker,localhost
  only:
    - schedules
    - master
  allow_failure: true
  script:
    - apk add jq
    - docker run -d --name db arminc/clair-db:latest
    - docker run -p 6060:6060 --link db:postgres -d --name clair --restart on-failure arminc/clair-local-scan:${CLAIR_LOCAL_SCAN_VERSION}
    - apk add -U wget ca-certificates
    - cat images-to-scan.txt | xargs -n1 docker pull
    - wget https://github.com/arminc/clair-scanner/releases/download/v8/clair-scanner_linux_amd64
    - mv clair-scanner_linux_amd64 clair-scanner
    - chmod +x clair-scanner
    - touch clair-whitelist.yml
    - retries=0
    - echo "Waiting for clair daemon to start"
    - while( ! wget -T 10 -q -O /dev/null http://docker:6060/v1/namespaces ) ; do sleep 1 ; echo -n "." ; if [ $retries -eq 10 ] ; then echo " Timeout, aborting." ; exit 1 ; fi ; retries=$(($retries+1)) ; done
    - mkdir scanning-reports
    - cat images-to-scan.txt | awk '{ system(sprintf("./clair-scanner -c http://docker:6060 --ip $(hostname -i) -r scanning-reports/report-%s.json -l clair.log -w clair-whitelist.yml %s || true", NR, $0)) }'
    - ls scanning-reports/ | xargs -I % sh -c "cat scanning-reports/% | jq '.image as \$prefix | .vulnerabilities[].description |= \$prefix + \" - \" + .' > scanning-reports/processed-%"
    - jq -s '[.[] | to_entries] | flatten | reduce .[] as $dot ({}; .[$dot.key] += $dot.value) | .image = "nlxio" | .unapproved |= unique' scanning-reports/processed-* > gl-container-scanning-report.json
  artifacts:
    paths:
      - scanning-reports/
      - gl-container-scanning-report.json
    reports:
      container_scanning: gl-container-scanning-report.json
