Build production:
  stage: Build
  before_script:
    - export DOCKER_CONFIG=/tmp/docker-config-$CI_JOB_ID
    - mkdir -p $DOCKER_CONFIG && echo $DOCKER_AUTH_CONFIG > $DOCKER_CONFIG/config.json
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
    - export GIT_COMMIT_HASH=$(git rev-parse HEAD)
    - export GIT_TAG_NAME=$(git describe --tags)
    - export JQ_BIN_PATH="./jq"
    - export IMAGE_PREFIX=""
    - export IMAGE_TAG_1="${GIT_TAG_NAME}"
    - export IMAGE_TAG_2="latest"
    - export IMAGE_TAG_3="${CI_COMMIT_REF_SLUG}"
  script:
    - docker version
    - ./scripts/install-jq.sh
    - ./scripts/build/build.sh
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  tags:
    - cg
    - shell

Trigger packaging build:
  stage: Build
  variables:
    PROJECT_ID: 23827875 # commonground/nlx/packaging
  script:
    - scripts/trigger-external-pipeline.sh "${PROJECT_ID}" "${CI_COMMIT_TAG:1}" "VERSION" "${CI_JOB_TOKEN}"
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  tags:
    - cg
    - shell

Trigger charts build:
  stage: Build
  variables:
    PROJECT_ID: 19568485 # commonground/charts
  script:
    - scripts/trigger-external-pipeline.sh "${PROJECT_ID}" "${CI_COMMIT_TAG:1}" "NLX_VERSION" "${CI_CHARTS_JOB_TOKEN}"
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  tags:
    - cg
    - shell
