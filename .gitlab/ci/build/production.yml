Build production:
  stage: Build
  before_script:
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
    - export GIT_COMMIT_HASH=$(git rev-parse HEAD)
    - export GIT_TAG_NAME=$(git describe --tags)
    - export IMAGE_PREFIX=""
  script:
    - docker-compose version
    - export IMAGE_TAG="${GIT_TAG_NAME}"
    - time docker-compose build --parallel
    - time docker-compose push
    - export IMAGE_TAG="latest"
    - time docker-compose build --parallel
    - time docker-compose push
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  tags:
    - cg
    - shell

Trigger packaging build:
  stage: Build
  variables:
    PROJECT_ID: 23827875  # commonground/nlx/packaging
  script:
    - STATUS_CODE=$(
        curl
          --silent
          --output /dev/stderr
          --write-out "%{http_code}"
          --request POST
          --form "ref=master"
          --form "variables[VERSION]=${CI_COMMIT_TAG:1}"
          --form "token=${CI_JOB_TOKEN}"
          "https://gitlab.com/api/v4/projects/${PROJECT_ID}/trigger/pipeline"
      )
    - test ${STATUS_CODE} -eq 200 || exit 1
  # rules:
  #   - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  tags:
    - cg
    - shell
