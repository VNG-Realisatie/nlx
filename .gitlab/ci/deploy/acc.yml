Deploy acceptance:
  stage: Deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  environment:
    name: acc
  before_script:
    - export KUBECONFIG=/secrets/kubeconfig/delta.conf
    - export GIT_COMMIT_HASH=$(git rev-parse HEAD)
    - export GIT_TAG_NAME=$(git describe --tags)
    - export IMAGE_PREFIX="${CI_REGISTRY_IMAGE}/"
    - export IMAGE_TAG="${GIT_TAG_NAME}"
  script:
    - |
      helm upgrade --install nlx-${CI_ENVIRONMENT_NAME}-directory ./helm/nlx-directory \
        --namespace nlx-${CI_ENVIRONMENT_NAME}-directory \
        --values ./helm/nlx-directory/values-${CI_ENVIRONMENT_NAME}.yaml \
        --set imageTag=$IMAGE_TAG \
        --set imagePrefix=$IMAGE_PREFIX
      for ORG in haarlem rdw brp
      do
        helm upgrade --install nlx-${CI_ENVIRONMENT_NAME}-${ORG} ./helm/nlx-organization \
          --namespace nlx-${CI_ENVIRONMENT_NAME}-${ORG} \
          --values ./helm/nlx-organization/values-${CI_ENVIRONMENT_NAME}-${ORG}.yaml \
          --set imageTag=$IMAGE_TAG \
          --set imagePrefix=$IMAGE_PREFIX
      done
  only:
    - master@commonground/nlx/nlx
  except:
    - tags
    - schedules
  tags:
    - cg-privileged
    - docker
