Deploy pre-production:
  stage: Deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  environment:
    name: pre-production
  variables:
    KUBECONFIG: /secrets/kubeconfig/dv-core-prod.conf
    K8S_NAMESPACE: nlx-${CI_ENVIRONMENT_NAME}
    CHART_DIRECTORY: ./helm/deploy/directory
    IMAGE_REGISTRY: registry.gitlab.com/commonground/nlx/nlx
    IMAGE_TAG: v0.86.0-340-g50faf58f
  script:
    - |
      helm upgrade nlx-directory ${CHART_DIRECTORY} \
        --install \
        --namespace ${K8S_NAMESPACE} \
        --set-string global.imageRegistry=${IMAGE_REGISTRY} \
        --set-string global.imageTag=${IMAGE_TAG} \
        --values ${CHART_DIRECTORY}/values-${CI_ENVIRONMENT_NAME}.yaml
  # dependencies:
  #  - Build production
  # rules:
  #   - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  #     when: manual
  tags:
    - cg-privileged
    - docker
