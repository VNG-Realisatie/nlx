Deploy demo, preprod & prod:
  stage: Deploy
  environment:
    name: demo
  before_script:
    - kubectl config use-context delta.k8s.nlx.io
    - export GIT_COMMIT_HASH=$(git rev-parse HEAD)
    - export GIT_TAG_NAME=$(git describe --tags)
    - export IMAGE_TAG="${GIT_TAG_NAME}"
  script:
    - |
      helm upgrade --install nlx-${CI_ENVIRONMENT_NAME}-directory ./helm/nlx-directory \
        --namespace nlx-${CI_ENVIRONMENT_NAME}-directory \
        --values ./helm/nlx-directory/values-${CI_ENVIRONMENT_NAME}.yaml \
        --set imageTag=$IMAGE_TAG
      for ORG in haarlem rdw brp
      do
        helm upgrade --install nlx-${CI_ENVIRONMENT_NAME}-${ORG} ./helm/nlx-organization \
          --namespace nlx-${CI_ENVIRONMENT_NAME}-${ORG} \
          --values ./helm/nlx-organization/values-${CI_ENVIRONMENT_NAME}-${ORG}.yaml \
          --set imageTag=$IMAGE_TAG
      done
    - |
      helm upgrade --install nlx-preprod-directory ./helm/nlx-directory \
        --namespace nlx-preprod-directory \
        --values ./helm/nlx-directory/values-preprod.yaml \
        --set imageTag=$IMAGE_TAG
    - |
      helm upgrade --install nlx-prod-directory ./helm/nlx-directory \
        --namespace nlx-prod-directory \
        --values ./helm/nlx-directory/values-prod.yaml \
        --set imageTag=$IMAGE_TAG
  only:
    - tags
  when: manual
  tags:
    - nlx-privileged
    - shell
