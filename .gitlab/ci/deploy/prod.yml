Deploy demo, preprod & prod:
  stage: Deploy
  environment:
    name: demo
  before_script:
    - kubectl config use-context delta.k8s.nlx.io
    - export GIT_COMMIT_HASH=$(git rev-parse HEAD)
    - export GIT_TAG_NAME=$(git describe --tags)
    - export IMAGE_TAG="${GIT_TAG_NAME}"
  script:
    - |
      helm upgrade --install nlx-demo-directory ./helm/nlx-directory \
        --namespace nlx-demo-directory \
        --values ./helm/nlx-directory/values-demo.yaml \
        --set imageTag=$IMAGE_TAG
    - |
      helm upgrade --install nlx-demo-brp ./helm/nlx-organization \
        --namespace nlx-demo-brp \
        --values ./helm/nlx-directory/values-demo-brp.yaml \
        --set imageTag=$IMAGE_TAG
    - |
      helm upgrade --install nlx-demo-rdw ./helm/nlx-organization \
        --namespace nlx-demo-rdw \
        --values ./helm/nlx-directory/values-demo-rdw.yaml \
        --set imageTag=$IMAGE_TAG
    - |
      helm upgrade --install nlx-demo-haarlem ./helm/nlx-organization \
        --namespace nlx-demo-haarlem \
        --values ./helm/nlx-directory/values-demo-haarlem.yaml \
        --set imageTag=$IMAGE_TAG
    - |
      helm upgrade --install nlx-preprod-directory ./helm/nlx-directory \
        --namespace nlx-preprod-directory \
        --values ./helm/nlx-directory/values-preprod.yaml \
        --set imageTag=$IMAGE_TAG
    - |
      helm upgrade --install nlx-prod-directory ./helm/nlx-directory \
        --namespace nlx-prod-directory \
        --values ./helm/nlx-directory/values-prod.yaml \
        --set imageTag=$IMAGE_TAG
  only:
    - tags
  when: manual
  tags:
    - nlx-privileged
    - shell
