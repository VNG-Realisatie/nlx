Deploy Review App:
  stage: Deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  variables:
    KUBECONFIG: /secrets/kubeconfig/review.conf
    IMAGE_PREFIX: "${REVIEW_REGISTRY_HOST}/${CI_PROJECT_PATH}/"
    IMAGE_TAG: $CI_COMMIT_SHORT_SHA
    REVIEW_BASE_DOMAIN: nlx.reviews
    NAME: "nlx-directory-${CI_ENVIRONMENT_SLUG}"
  script:
    - echo -e -n "$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN" > ci_environment_url.txt
    - |
        echo "install/upgrade ${NAME}"
        helm upgrade --install ${NAME} ./helm/nlx-directory \
        --namespace ${NAME} \
        --values ./helm/nlx-directory/values-review.yaml \
        --set imageTag=$IMAGE_TAG \
        --set imagePrefix=$IMAGE_PREFIX \
        --set "caAddress=ca-cfssl-unsafe.${NAME}" \
        --set "insightDirectoryInspectionAPIURL=http://directory-inspection-api-internal.${NAME}" \
        --set "externalDomain=${NAME}.${REVIEW_BASE_DOMAIN}" \
        --set "domain=${NAME}" \
        --set "reviewPage.environmentSlugWithDomain=${CI_ENVIRONMENT_SLUG}.${REVIEW_BASE_DOMAIN}"
    - |
        for ORG in haarlem rdw brp lorem ipsum
        do
          ORG_NAME=nlx-${ORG}-${CI_ENVIRONMENT_SLUG}
          echo "install/upgrade ${ORG_NAME}"
          helm upgrade --install ${ORG_NAME} ./helm/nlx-organization \
          --namespace ${ORG_NAME} \
          --values ./helm/nlx-organization/values-review-${ORG}.yaml \
          --set imageTag=$IMAGE_TAG \
          --set imagePrefix=$IMAGE_PREFIX \
          --set "directoryRegistrationHostname=directory-registration-api.${NAME}" \
          --set "directoryInspectionHostname=directory-inspection-api.${NAME}" \
          --set "caAddress=ca-cfssl-unsafe.${NAME}" \
          --set "externalDomain=${ORG_NAME}.${REVIEW_BASE_DOMAIN}" \
          --set "management.accountsCsv=${MANAGEMENT_ACCOUNTS}" \
          --set "domain=${ORG_NAME}"
        done
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://review-nlx-directory-$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    on_stop: Remove Review App
  only:
    - /^feature/.*$/@commonground/nlx/nlx
  artifacts:
    paths:
      - ci_environment_url.txt
  tags:
    - cg
    - docker

Remove Review App:
  stage: Deploy
  image: registry.gitlab.com/commonground/core/review-app-deployer:latest
  variables:
    GIT_STRATEGY: none
    KUBECONFIG: /secrets/kubeconfig/review.conf
  script:
    - |
        for NAME in haarlem rdw brp lorem ipsum directory; do
          helm delete --purge nlx-$NAME-$CI_ENVIRONMENT_SLUG
          kubectl delete namespace nlx-$NAME-$CI_ENVIRONMENT_SLUG
        done
  when: manual
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    action: stop
  only:
    - /^feature/.*$/@commonground/nlx/nlx
  tags:
    - cg
    - docker
