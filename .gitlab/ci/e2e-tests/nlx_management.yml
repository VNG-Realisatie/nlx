.management-e2e-tests-base:
  extends: .node-base
  # BrowserStack does not run on Alpine. See https://github.com/browserstack/browserstack-local-nodejs/issues/33
  image: node:14.15.0
  stage: E2E tests
  retry: 1
  variables:
    BROWSERSTACK_BUILD_ID: "Commit $CI_COMMIT_SHORT_SHA"
  artifacts:
    when: always
    paths:
      - management-ui-e2e-tests/test-results/

NLX Management - E2E-tests (all):
  extends: .management-e2e-tests-base
  variables:
    BROWSERSTACK_PROJECT_NAME: "NLX Management E2E-tests complete"
  script:
    - source e2e_environment.sh
    - export CI_ENV_URL=$([ -f ci_environment_url.txt ] && cat ci_environment_url.txt)
    - export URL=$([ -z "$CI_ENV_URL" ] && echo "https://management.acc.voorbeeld-rdw.nl" || echo "https://nlx-management-rdw-$CI_ENV_URL")
    - cd management-ui-e2e-tests/
    - install_npm_dependencies
    - wait_for_http "${URL}"
    - start_section test "Running tests"
    - npm run test:browserstack:all
    - stop_section test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
    - if: '$CI_COMMIT_BRANCH =~ /^review\/.*$/ && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
      when: never

NLX Management - E2E-tests (edge only):
  extends: .management-e2e-tests-base
  variables:
    BROWSERSTACK_PROJECT_NAME: "NLX Management E2E-tests edge only"
  script:
    - source e2e_environment.sh
    - export CI_ENV_URL=$([ -f ci_environment_url.txt ] && cat ci_environment_url.txt)
    - export URL="https://nlx-management-rdw-$CI_ENV_URL"
    - cd management-ui-e2e-tests/
    - install_npm_dependencies
    - wait_for_http "${URL}"
    - start_section test "Running tests"
    - npm run test:browserstack:edge
    - stop_section test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
      when: never
    - if: '$CI_COMMIT_BRANCH =~ /^review\/.*$/ && $CI_PROJECT_PATH == "commonground/nlx/nlx"'

NLX Management - E2E-tests (all, except edge):
  extends: .management-e2e-tests-base
  variables:
    BROWSERSTACK_PROJECT_NAME: "NLX Management E2E-tests all, except edge"
  script:
    - source e2e_environment.sh
    - export CI_ENV_URL=$([ -f ci_environment_url.txt ] && cat ci_environment_url.txt)
    - export URL="https://nlx-management-rdw-$CI_ENV_URL"
    - cd management-ui-e2e-tests/
    - install_npm_dependencies
    - wait_for_http "${URL}"
    - start_section test "Running tests"
    - npm run test:browserstack:all-except-edge
    - stop_section test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
      when: never
    - if: '$CI_COMMIT_BRANCH =~ /^review\/.*$/ && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
      when: manual
      allow_failure: true
