# Copyright Â© VNG Realisatie 2022
# Licensed under the EUPL

.push-production-base:
  stage: Push
  image: docker:24.0.7-git
  services:
    - docker:24.0.7-dind
  before_script:
    - export DOCKER_CONFIG=/tmp/docker-config-$CI_JOB_ID
    - mkdir -p $DOCKER_CONFIG && echo $DOCKER_AUTH_CONFIG > $DOCKER_CONFIG/config.json
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - export GIT_COMMIT_HASH=$(git rev-parse HEAD)
    - export GIT_TAG_NAME=$(git describe --tags)
    - export IMAGE_PREFIX=""
  variables:
    DOCKER_BUILDKIT: 1
  script:
    - export IMG_GIT_TAG=${IMAGE_PREFIX}nlxio/${IMAGE}:${GIT_TAG_NAME}
    - export IMG_LATEST=${IMAGE_PREFIX}nlxio/${IMAGE}:latest
    - docker pull ${CI_REGISTRY_IMAGE}/nlxio/${IMAGE}:${GIT_TAG_NAME}
    - docker tag ${CI_REGISTRY_IMAGE}/nlxio/${IMAGE}:${GIT_TAG_NAME} ${IMG_GIT_TAG}
    - docker tag ${CI_REGISTRY_IMAGE}/nlxio/${IMAGE}:${GIT_TAG_NAME} ${IMG_LATEST}
    - docker push ${IMG_GIT_TAG}
    - docker push ${IMG_LATEST}
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "commonground/nlx/nlx"'
  tags:
    - commonground-k8s-runners

Push production apps-overview:
  extends: .push-production-base
  variables:
    IMAGE: apps-overview

Push production auth-opa:
  extends: .push-production-base
  variables:
    IMAGE: auth-opa

Push production ca-certportal:
  extends: .push-production-base
  variables:
    IMAGE: ca-certportal


Push production docs:
  extends: .push-production-base
  variables:
    IMAGE: docs

Push production directory-api:
  extends: .push-production-base
  variables:
    IMAGE: directory-api

Push production directory-monitor:
  extends: .push-production-base
  variables:
    IMAGE: directory-monitor

Push production directory-ui:
  extends: .push-production-base
  variables:
    IMAGE: directory-ui

Push production inway:
  extends: .push-production-base
  variables:
    IMAGE: inway

Push production management-api:
  extends: .push-production-base
  variables:
    IMAGE: management-api

Push production management-ui:
  extends: .push-production-base
  variables:
    IMAGE: management-ui

Push production nlxctl:
  extends: .push-production-base
  variables:
    IMAGE: nlxctl

Push production outway:
  extends: .push-production-base
  variables:
    IMAGE: outway

Push production txlog-api:
  extends: .push-production-base
  variables:
    IMAGE: txlog-api
