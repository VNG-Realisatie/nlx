Deploy Review App:
  stage: Review
  image: registry.gitlab.com/commonground/cg-review-app-deployer:latest
  variables:
    REVIEW_BASE_DOMAIN: nlx.reviews
  before_script:
    - mkdir -p ~/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > ~/.docker/config.json
  script:
    - echo -e -n "$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN" > ci_environment_url.txt
    - skaffold run --profile review-directory --namespace nlx-directory-$CI_ENVIRONMENT_SLUG --default-repo registry-docker-registry.registry:5000 --insecure-registry registry-docker-registry.registry:5000
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://review-nlx-directory-$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    on_stop: Remove Review App
  tags:
    - review
    - kubernetes
  only:
    - /^feature\/.*$/
  artifacts:
    paths:
      - ci_environment_url.txt

Remove Review App:
  stage: Review
  image: registry.gitlab.com/commonground/cg-review-app-deployer:latest
  variables:
    GIT_STRATEGY: none
  script:
    - helm delete --purge nlx-directory-$CI_ENVIRONMENT_SLUG
    - helm delete --purge nlx-haarlem-$CI_ENVIRONMENT_SLUG
    - helm delete --purge nlx-rdw-$CI_ENVIRONMENT_SLUG
    - helm delete --purge nlx-brp-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-directory-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-haarlem-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-rdw-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-brp-$CI_ENVIRONMENT_SLUG
  when: manual
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    action: stop
  tags:
    - review
    - kubernetes
  only:
    - /^feature\/.*$/
