Deploy Review App:
  stage: Review
  image: registry.gitlab.com/commonground/cg-review-app-deployer:latest
  variables:
    IMAGE_PREFIX: "$CI_REGISTRY/$CI_PROJECT_PATH"
    REVIEW_BASE_DOMAIN: nlx.reviews
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - docker:dind
  script:
    - echo -e -n "https://$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN" > ci_environment_url.txt
    - skaffold deploy --profile deploy-review-directory --namespace nlx-directory-$CI_ENVIRONMENT_SLUG
    - skaffold deploy --profile deploy-review-haarlem --namespace nlx-haarlem-$CI_ENVIRONMENT_SLUG
    - skaffold deploy --profile deploy-review-rdw --namespace nlx-rdw-$CI_ENVIRONMENT_SLUG
    - skaffold deploy --profile deploy-review-brp --namespace nlx-brp-$CI_ENVIRONMENT_SLUG
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://application.nlx-haarlem-$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    on_stop: Remove Review App
  tags:
    - review
    - kubernetes
  only:
    - /^feature\/.*$/
  artifacts:
    paths:
      - ci_environment_url.txt

Remove Review App:
  stage: Review
  image: registry.gitlab.com/commonground/cg-review-app-deployer:latest
  variables:
    GIT_STRATEGY: none
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  services:
    - docker:dind
  script:
    - helm delete --purge nlx-directory-$CI_ENVIRONMENT_SLUG
    - helm delete --purge nlx-haarlem-$CI_ENVIRONMENT_SLUG
    - helm delete --purge nlx-rdw-$CI_ENVIRONMENT_SLUG
    - helm delete --purge nlx-brp-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-directory-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-haarlem-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-rdw-$CI_ENVIRONMENT_SLUG
    - kubectl delete namespace nlx-brp-$CI_ENVIRONMENT_SLUG
  when: manual
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$REVIEW_BASE_DOMAIN
    action: stop
  tags:
    - review
    - kubernetes
  only:
    - /^feature\/.*$/
