version: "3.7"

x-env: &env
  TLS_NLX_ROOT_CERT: /certs/nlx-pki-root.crt
  TLS_ORG_CERT: /certs/nlx-pki-cert.crt
  TLS_ORG_KEY: /certs/nlx-pki-key.key
  TLS_ROOT_CERT: /certs/internal-root.crt
  TLS_CERT: /certs/internal-cert.crt
  TLS_KEY: /certs/internal-cert.key
  DISABLE_LOGDB: '1'
  DIRECTORY_INSPECTION_ADDRESS: directory-inspection-api.demo.nlx.io:443
  DIRECTORY_REGISTRATION_ADDRESS: directory-registration-api.demo.nlx.io:443

x-certs: &certs
  - ~/nlx-setup/root.crt:/certs/nlx-pki-root.crt:ro
  - ~/nlx-setup/org.crt:/certs/nlx-pki-cert.crt:ro
  - ~/nlx-setup/org.key:/certs/nlx-pki-key.key:ro
  - ./pki/organization-a/ca/intermediate.pem:/certs/internal-root.crt:ro
  - ./pki/organization-a/certs/management-api/cert.pem:/certs/internal-cert.crt:ro
  - ./pki/organization-a/certs/management-api/key.pem:/certs/internal-cert.key:ro

services:
  ui:
    image: nlxio/management-ui:latest
    ports:
      - 127.0.0.1:8080:8080
    restart: always
    links:
      - api:management-api.organization-a.nlx.local
    environment:
      LISTEN_ADDRESS: 0.0.0.0:8080
      MANAGEMENT_API_ADDRESS: http://management-api.organization-a.nlx.local:8080

  dex:
    image: quay.io/dexidp/dex:v2.25.0
    ports:
      - 127.0.0.1:5556:5556
    command: serve /config.yaml
    volumes:
      - ./dex.management.yaml:/config.yaml
    restart: always

  etcd:
    image: gcr.io/etcd-development/etcd:v3.4.13
    ports:
      - 127.0.0.1:2379:2379
    environment:
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://127.0.0.1:2379
      ETCD_DATA_DIR: /default.etcd/a
    volumes:
      - etcd-data:/default.etcd
    restart: always

  outway:
    image: nlxio/outway:latest
    restart: always
    ports:
      - 127.0.0.1:80:8080
    environment:
      <<: *env
      LISTEN_ADDRESS: 0.0.0.0:8080
    volumes: *certs

  inway:
    image: nlxio/inway:latest
    restart: always
    links:
      - api:management-api.organization-a.nlx.local
    ports:
      - 127.0.0.1:443:8443
    environment:
      <<: *env
      LISTEN_ADDRESS: 0.0.0.0:8443
      INWAY_NAME: Inway-01
      SELF_ADDRESS: "${INWAY_SELF_ADDRESS}"
      MANAGEMENT_API_ADDRESS: management-api.organization-a.nlx.local:8443
    volumes: *certs

  api:
    image: nlxio/management-api:latest
    restart: always
    links:
      - dex:dex.nlx.localhost
    volumes: *certs
    environment:
      <<: *env
      LISTEN_ADDRESS: 0.0.0.0:8080
      CONFIG_LISTEN_ADDRESS: 0.0.0.0:8443
      ETCD_CONNECTION_STRING: http://etcd:2379
      SECRET_KEY: Ct6HZ5bQMLm2ytKvU6Yc
      OIDC_CLIENT_ID: nlx-management
      OIDC_CLIENT_SECRET: ZXhhbXBsZS1hcHAtc2VjcmV0
      OIDC_DISCOVERY_URL: http://dex.nlx.localhost:5556
      OIDC_REDIRECT_URL: http://localhost:8080/oidc/callback
      SESSION_COOKIE_SECURE: "0"

volumes:
  etcd-data:
