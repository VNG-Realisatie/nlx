{{ if .Values.management.enable }}
{{ if .Values.dex.enable }}
{{ with set . "component" "dex" }}
apiVersion: apps/v1
kind: Deployment
metadata: {{ include "nlx-organization.common.metadata" . | nindent 2 }}
spec:
  replicas: 1
  selector:
    matchLabels: {{ include "nlx-organization.common.metadata-labels" . | nindent 6 }}
  template:
    metadata:
      labels: {{ include "nlx-organization.common.metadata-labels" . | nindent 8 }}
    spec:
      containers:
        - name: {{ .component }}
          image: quay.io/dexidp/dex:v2.20.0
          imagePullPolicy: {{.Values.imagePullPolicy}}
          args: ["serve", "/config/dex.yaml"]
          volumeMounts:
          - name: config
            mountPath: /config
      volumes:
        - name: config
          configMap:
            name: {{ .component }}
---
apiVersion: v1
kind: Service
metadata: {{ include "nlx-organization.common.metadata" . | nindent 2 }}
spec:
  selector: {{ include "nlx-organization.common.metadata-labels" . | nindent 4 }}
  ports:
  - name: http
    protocol: TCP
    port: 8080
    targetPort: 8080
---
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata: {{ include "nlx-organization.common.metadata" . | nindent 2 }}
  annotations:
    ingress.kubernetes.io/hsts-include-subdomains: 'true'
    ingress.kubernetes.io/hsts-max-age: '315360000'
    ingress.kubernetes.io/hsts-preload: 'true'
    kubernetes.io/ingress.class: traefik
spec:
  rules:
  - host: dex{{ if .Values.servicePartOfExternalDomain }}-{{ else }}.{{ end }}{{.Values.externalDomain}}
    http:
      paths:
      - path: /
        backend:
          serviceName: {{ .component }}
          servicePort: http
---
apiVersion: v1
kind: ConfigMap
metadata: {{ include "nlx-organization.common.metadata" . | nindent 2 }}
data:
  dex.yaml: |-
      issuer: {{ .Values.management.oidcDiscoveryUrl }}

      storage:
        type: sqlite3
        config:
          file: /tmp/dex.db

      web:
        http: 0.0.0.0:8080

      staticClients:
        - id: {{ .Values.management.oidcClientId }}
          redirectURIs:
            - '{{ .Values.management.oidcRedirectUrl }}'
          name: 'NLX Management'
          secret: {{ .Values.management.oidcClientSecret }}

      enablePasswordDB: true

      staticPasswords:
        - email: "admin@example.com"
          hash: "$2a$10$2b2cU8CPhOTaGrs1HRQuAueS7JTT5ZHsHSzYiFPm1leZck7Mc8T4W"  # hash for: password
          username: "admin"
          name: "admin"
          userID: "23b027bf-b1b1-4a08-b95b-921d4afc38bc"
{{ end }}
{{ end }}
{{ end }}
