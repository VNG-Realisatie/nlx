// Copyright Â© VNG Realisatie 2022
// Licensed under the EUPL

syntax = "proto3";

package nlx.management;

option go_package = "go.nlx.io/nlx/management-api/api";

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

service Management {
  rpc SynchronizeOrders(google.protobuf.Empty) returns (SynchronizeOrdersResponse) {
    option (google.api.http) = {post: "/api/v1/orders/synchronize" response_body: '*'};
  }
  rpc IsFinanceEnabled (google.protobuf.Empty) returns (IsFinanceEnabledResponse) {
    option (google.api.http) = {get: "/api/v1/finance/enabled"};
  }
  rpc IsTXLogEnabled (google.protobuf.Empty) returns (IsTXLogEnabledResponse) {
    option (google.api.http) = {get: "/api/v1/txlog/enabled"};
  }
  rpc DownloadFinanceExport (google.protobuf.Empty) returns (DownloadFinanceExportResponse) {
    option (google.api.http) = {get: "/api/v1/finance/export"};
  }
  rpc ListServices (ListServicesRequest) returns (ListServicesResponse) {
    option (google.api.http) = {get: "/api/v1/services"};
  }
  rpc GetService (GetServiceRequest) returns (GetServiceResponse) {
    option (google.api.http) = {get: "/api/v1/services/{name}"};
  }
  rpc CreateService (CreateServiceRequest) returns (CreateServiceResponse) {
    option (google.api.http) = {post: "/api/v1/services" body: "*" response_body: '*'};
  }
  rpc UpdateService (UpdateServiceRequest) returns (UpdateServiceResponse) {
    option (google.api.http) = {put: "/api/v1/services/{name}" body: "*" response_body: '*'};
  }
  rpc DeleteService (DeleteServiceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/services/{name}" response_body: '*'};
  }
  rpc GetStatisticsOfServices (GetStatisticsOfServicesRequest) returns (GetStatisticsOfServicesResponse) {
    option (google.api.http) = {get: "/api/v1/statistics/services"};
  }
  rpc ListInways (ListInwaysRequest) returns (ListInwaysResponse) {
    option (google.api.http) = {get: "/api/v1/inways"};
  }
  rpc GetInway (GetInwayRequest) returns (Inway) {
    option (google.api.http) = {get: "/api/v1/inways/{name}"};
  }
  rpc RegisterInway (Inway) returns (Inway) {
    option (google.api.http) = {post: "/api/v1/inways" body: "*"};
  }
  rpc UpdateInway (UpdateInwayRequest) returns (Inway) {
    option (google.api.http) = {put: "/api/v1/inways/{name}" body: "inway"};
  }
  rpc DeleteInway (DeleteInwayRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/inways/{name}" response_body: '*'};
  }
  rpc RegisterOutway (RegisterOutwayRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {post: "/api/v1/outways" body: "*"};
  }
  rpc ListOutways(ListOutwaysRequest) returns (ListOutwaysResponse){
    option (google.api.http) = {get :"/api/v1/outways"};
  }
  rpc DeleteOutway (DeleteOutwayRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {delete: "/api/v1/outways/{name}" response_body: '*'};
  }
  rpc ListIncomingAccessRequests (ListIncomingAccessRequestsRequest) returns (ListIncomingAccessRequestsResponse) {
    option (google.api.http) = {get: "/api/v1/access-requests/incoming/services/{serviceName}"};
  }
  rpc ApproveIncomingAccessRequest (ApproveIncomingAccessRequestRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {post: "/api/v1/access-requests/incoming/services/{serviceName}/{accessRequestID}/approve" response_body: '*'};
  }
  rpc RejectIncomingAccessRequest (RejectIncomingAccessRequestRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {post: "/api/v1/access-requests/incoming/services/{serviceName}/{accessRequestID}/reject" response_body: '*'};
  }
  rpc SendAccessRequest (SendAccessRequestRequest) returns (SendAccessRequestResponse) {
    option (google.api.http) = {post: "/api/v1/access-requests/outgoing/{organizationSerialNumber}/services/{serviceName}"};
  }
  rpc GetSettings (google.protobuf.Empty) returns (Settings) {
    option (google.api.http) = {get: "/api/v1/settings"};
  }
  rpc UpdateSettings(UpdateSettingsRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {put: "/api/v1/settings", body: "*" response_body: '*'};
  }
  rpc ListAccessGrantsForService(ListAccessGrantsForServiceRequest) returns(ListAccessGrantsForServiceResponse) {
    option (google.api.http) = {get: "/api/v1/access-grants/services/{serviceName}"};
  }
  rpc RevokeAccessGrant(RevokeAccessGrantRequest) returns (AccessGrant) {
    option (google.api.http) = {post: "/api/v1/access-grants/{accessGrantID}/revoke" response_body: '*'};
  }
  rpc ListAuditLogs (google.protobuf.Empty) returns (ListAuditLogsResponse) {
    option (google.api.http) = {get: "/api/v1/audit-logs"};
  }
  rpc CreateOutgoingOrder (CreateOutgoingOrderRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {post: "/api/v1/orders/outgoing" body: "*" response_body: '*'};
  }
  rpc UpdateOutgoingOrder (UpdateOutgoingOrderRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {put: "/api/v1/orders/outgoing" body: "*" response_body: '*'};
  }
  rpc RevokeOutgoingOrder (RevokeOutgoingOrderRequest) returns (google.protobuf.Empty){
    option (google.api.http) = {put: "/api/v1/orders/outgoing/{delegatee}/{reference}/revoke" response_body: '*'};
  }
  rpc ListOutgoingOrders (google.protobuf.Empty) returns (ListOutgoingOrdersResponse) {
    option (google.api.http) = {get: "/api/v1/orders/outgoing"};
  }
  rpc ListIncomingOrders (google.protobuf.Empty) returns (ListIncomingOrdersResponse) {
    option (google.api.http) = {get: "/api/v1/orders/incoming"};
  }
  rpc GetTermsOfServiceStatus (google.protobuf.Empty) returns (GetTermsOfServiceStatusResponse) {
    option (google.api.http) = {get: "/api/v1/terms-of-service"};
  }
  rpc AcceptTermsOfService (google.protobuf.Empty) returns (google.protobuf.Empty) {
    option (google.api.http) = {post: "/api/v1/terms-of-service" response_body: '*'};
  }

  rpc GetInwayConfig (GetInwayConfigRequest) returns (GetInwayConfigResponse) {}

  rpc SynchronizeOutgoingAccessRequests (SynchronizeOutgoingAccessRequestsRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {get: "/api/v1/access-requests/outgoing/{organizationSerialNumber}/services/{serviceName}/synchronize"};
  }

  rpc SynchronizeAllOutgoingAccessRequests (google.protobuf.Empty) returns (google.protobuf.Empty) {
    option (google.api.http) = {get: "/api/v1/access-requests/outgoing/synchronize"};
  }
}

message Organization {
  string serial_number = 1;
  string name = 2;
}

message SynchronizeOrdersResponse {
  repeated IncomingOrder orders = 1;
}

message IsFinanceEnabledResponse {
  bool enabled = 1;
}

message IsTXLogEnabledResponse {
  bool enabled = 1;
}

message DownloadFinanceExportResponse {
  bytes data = 1;
}

message GetServiceResponse {
  string name = 1;
  string endpointURL = 2;
  string documentationURL = 3;
  string apiSpecificationURL = 4;
  bool internal = 5;
  string techSupportContact = 6;
  string publicSupportContact = 7;
  repeated string inways = 9;
  int32 oneTimeCosts = 10;
  int32 monthlyCosts = 11;
  int32 requestCosts = 12;
}

message CreateServiceRequest {
  string name = 1;
  string endpointURL = 2;
  string documentationURL = 3;
  string apiSpecificationURL = 4;
  bool internal = 5;
  string techSupportContact = 6;
  string publicSupportContact = 7;
  repeated string inways = 9;
  int32 oneTimeCosts = 10;
  int32 monthlyCosts = 11;
  int32 requestCosts = 12;
}

message CreateServiceResponse {
  string name = 1;
  string endpointURL = 2;
  string documentationURL = 3;
  string apiSpecificationURL = 4;
  bool internal = 5;
  string techSupportContact = 6;
  string publicSupportContact = 7;
  repeated string inways = 9;
  int32 oneTimeCosts = 10;
  int32 monthlyCosts = 11;
  int32 requestCosts = 12;
}

message UpdateServiceRequest {
  string name = 1;
  string endpointURL = 2;
  string documentationURL = 3;
  string apiSpecificationURL = 4;
  bool internal = 5;
  string techSupportContact = 6;
  string publicSupportContact = 7;
  repeated string inways = 9;
  int32 oneTimeCosts = 10;
  int32 monthlyCosts = 11;
  int32 requestCosts = 12;
}

message UpdateServiceResponse {
  string name = 1;
  string endpointURL = 2;
  string documentationURL = 3;
  string apiSpecificationURL = 4;
  bool internal = 5;
  string techSupportContact = 6;
  string publicSupportContact = 7;
  repeated string inways = 9;
  int32 oneTimeCosts = 10;
  int32 monthlyCosts = 11;
  int32 requestCosts = 12;
}

message Inway {
  message Service {
    string name = 1;
  }

  string name = 1;
  string version = 2;
  string hostname = 3;
  string selfAddress = 4;
  repeated Service services = 5;
  string ipAddress = 6;
}

message Outway {
  string name = 1;
  string ipAddress = 2;
  string publicKeyPEM = 3;
  string version = 4;
  string publicKeyFingerprint = 5;
  string selfAddressAPI = 6;
}

message RegisterOutwayRequest {
  string name = 1;
  string publicKeyPEM = 2;
  string version = 3;
  string selfAddressAPI = 4;
}

message ListOutwaysRequest {}

message ListOutwaysResponse {
  repeated Outway outways = 1;
}

message DeleteOutwayRequest {
  string name = 1;
}

message GetStatisticsOfServicesRequest {}

message GetStatisticsOfServicesResponse {
  repeated ServiceStatistics services = 1;
}

message ServiceStatistics {
  string name = 1;
  uint32 incomingAccessRequestCount = 2;
}

message ListServicesRequest {
}

message ListServicesResponse {
  repeated Service services = 1;

  message Service {
    string name = 1;
    string endpointURL = 2;
    string documentationURL = 3;
    string apiSpecificationURL = 4;
    bool internal = 5;
    string techSupportContact = 6;
    string publicSupportContact = 7;
    AuthorizationSettings authorizationSettings = 8;
    repeated string inways = 9;
    uint32 incomingAccessRequestCount = 10;
    int32 oneTimeCosts = 11;
    int32 monthlyCosts = 12;
    int32 requestCosts = 13;

    message AuthorizationSettings {
      message Authorization  {
        Organization organization = 1;
        string publicKeyHash = 2;
        string publicKeyPEM = 3;
      }

      string mode = 1;
      repeated Authorization authorizations = 2;
    }
  }
}

message GetServiceRequest {
  string name = 1;
}

message DeleteServiceRequest {
  string name = 1;
}

message ListInwaysRequest {}

message ListInwaysResponse {
  repeated Inway inways = 1;
}

message GetInwayRequest {
  string name = 1;
}

message UpdateInwayRequest {
  string name = 1;
  Inway inway = 2;
}

message DeleteInwayRequest {
  string name = 1;
}

message GetInwayConfigRequest {
    string name = 1;
}
message GetInwayConfigResponse {
    repeated Service services = 1;
    bool isOrganizationInway = 2;

    message Service {
        string name = 1;
        string endpointURL = 2;
        string documentationURL = 3;
        string apiSpecificationURL = 4;
        bool internal = 5;
        string techSupportContact = 6;
        string publicSupportContact = 7;
        AuthorizationSettings authorizationSettings = 8;
        int32 oneTimeCosts = 9;
        int32 monthlyCosts = 10;
        int32 requestCosts = 11;

        message AuthorizationSettings {
            message Authorization  {
                Organization organization = 1;
                string publicKeyHash = 2;
                string publicKeyPEM = 3;
            }
            repeated Authorization authorizations = 1;
        }
    }
}

enum AccessRequestStateDeprecated {
  UNSPECIFIED = 0;
  FAILED = 1;
  reserved 2; // Removed deprecated option 'CREATED'
  RECEIVED = 3;
  APPROVED = 4;
  REJECTED = 5;
  REVOKED = 6;
}

enum AccessRequestState {
  ACCESS_REQUEST_STATE_UNSPECIFIED = 0;
  ACCESS_REQUEST_STATE_FAILED = 1;
  reserved 2; // Removed deprecated option 'CREATED'
  ACCESS_REQUEST_STATE_RECEIVED = 3;
  ACCESS_REQUEST_STATE_APPROVED = 4;
  ACCESS_REQUEST_STATE_REJECTED = 5;
  ACCESS_REQUEST_STATE_REVOKED = 6;
}

enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  ERROR_CODE_INTERNAL = 1;
  ERROR_CODE_NO_INWAY_SELECTED = 2;
}

message ErrorDetails {
  ErrorCode code = 1;
  string cause = 2;
  repeated string stackTrace = 3;
}

message OutgoingAccessRequest {
  uint64 id = 1;
  Organization organization = 2;
  string serviceName = 3;
  AccessRequestState state = 4;
  google.protobuf.Timestamp createdAt = 5;
  google.protobuf.Timestamp updatedAt = 6;
  ErrorDetails errorDetails = 7;
  string publicKeyFingerprint = 8;
}

message IncomingAccessRequest {
  uint64 id = 1;
  Organization organization = 2;
  string serviceName = 3;
  AccessRequestState state = 4;
  google.protobuf.Timestamp createdAt = 5;
  google.protobuf.Timestamp updatedAt = 6;
  string publicKeyFingerprint = 7;
}

message ListIncomingAccessRequestsRequest {
  string serviceName = 1;
}

message ListIncomingAccessRequestsResponse {
  repeated IncomingAccessRequest accessRequests = 1;
}

message ApproveIncomingAccessRequestRequest {
  string serviceName = 1;
  uint64 accessRequestID = 2;
}

message RejectIncomingAccessRequestRequest {
  string serviceName = 1;
  uint64 accessRequestID = 2;
}

message SendAccessRequestRequest {
    string organizationSerialNumber = 1;
    string serviceName = 2;
    string publicKeyPEM = 3;
}

message SendAccessRequestResponse {
    OutgoingAccessRequest outgoingAccessRequest = 1;
}

message ListAccessGrantsForServiceRequest {
  string serviceName = 1;
}

message ListAccessGrantsForServiceResponse {
  repeated AccessGrant accessGrants = 1;
}

message RevokeAccessGrantRequest {
  uint64 accessGrantID = 1;
}

message AccessGrant {
  uint64 id = 1;
  Organization organization = 2;
  string serviceName = 3;
  string publicKeyFingerprint = 4;
  google.protobuf.Timestamp createdAt = 5;
  google.protobuf.Timestamp revokedAt = 6;
  uint64 accessRequestId = 7;
}

message AccessProof {
  uint64 id = 1;
  Organization organization = 2;
  string service_name = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp revoked_at = 5;
  uint64 access_request_id = 6;
  string public_key_fingerprint = 7;
}

service Directory {
  rpc ListServices (google.protobuf.Empty) returns (DirectoryListServicesResponse) {
    option (google.api.http) = {get: "/api/v1/directory/services"};
  }
  rpc GetOrganizationService (GetOrganizationServiceRequest) returns (DirectoryService) {
    option (google.api.http) = {get: "/api/v1/directory/organizations/{organizationSerialNumber}/services/{serviceName}"};
  }
  rpc RequestAccessToService (RequestAccessToServiceRequest) returns (OutgoingAccessRequest) {
    option (google.api.http) = {post: "/api/v1/directory/organizations/{organizationSerialNumber}/services/{serviceName}/access-requests"};
  }
  rpc GetTermsOfService (google.protobuf.Empty) returns (GetTermsOfServiceResponse) {
      option (google.api.http) = {get: "/api/v1/directory/terms-of-service"};
  }
}

message DirectoryListServicesResponse {
  repeated DirectoryService services = 1;
}

message GetTermsOfServiceResponse {
    bool enabled = 1;
    string url = 2;
}

message GetOrganizationServiceRequest {
  string organizationSerialNumber = 1;
  string serviceName = 2;
}

message DirectoryAccessRequest {
  string id = 1;
  AccessRequestState state = 2;
  google.protobuf.Timestamp createdAt = 3;
  google.protobuf.Timestamp updatedAt = 4;
}

message DirectoryService {
  enum State {
    STATE_UNSPECIFIED = 0;
    STATE_UP = 1;
    STATE_DOWN = 2;
    STATE_DEGRADED = 3;
  }

  message AccessState {
    OutgoingAccessRequest accessRequest = 1;
    AccessProof accessProof = 2;
  }

  string serviceName = 1;
  Organization organization = 2;
  string apiSpecificationType = 3;
  string documentationURL = 4;
  string publicSupportContact = 5;
  State state = 6;
  int32 oneTimeCosts = 7;
  int32 monthlyCosts = 8;
  int32 requestCosts = 9;
  repeated AccessState accessStates = 10;
}

message RequestAccessToServiceRequest {
  string organizationSerialNumber = 1;
  string serviceName = 2;
}

message Settings {
  string organizationInway = 1;
  string organizationEmailAddress = 2;
}

message UpdateSettingsRequest{
  string organizationInway = 1;
  string organizationEmailAddress = 2;
}

message AuditLogRecord {
  enum ActionType {
    ACTION_TYPE_UNSPECIFIED = 0;
    ACTION_TYPE_LOGIN_SUCCESS = 1;
    ACTION_TYPE_LOGIN_FAIL = 2;
    ACTION_TYPE_LOGOUT = 3;
    ACTION_TYPE_INCOMING_ACCESS_REQUEST_ACCEPT = 4;
    ACTION_TYPE_INCOMING_ACCESS_REQUEST_REJECT = 5;
    ACTION_TYPE_ACCESS_GRANT_REVOKE = 6;
    ACTION_TYPE_OUTGOING_ACCESS_REQUEST_CREATE = 7;
    ACTION_TYPE_OUTGOING_ACCESS_REQUEST_FAIL = 8;
    ACTION_TYPE_SERVICE_CREATE = 9;
    ACTION_TYPE_SERVICE_UPDATE = 10;
    ACTION_TYPE_SERVICE_DELETE = 11;
    ACTION_TYPE_ORGANIZATION_SETTINGS_UPDATE = 12;
    ACTION_TYPE_ORDER_CREATE = 13;
    ACTION_TYPE_ORDER_OUTGOING_REVOKE = 14;
    ACTION_TYPE_ORDER_INCOMING_REVOKE = 15;
    ACTION_TYPE_INWAY_DELETE = 16;
    ACTION_TYPE_ORDER_OUTGOING_UPDATE = 17;
    ACTION_TYPE_ACCEPT_TERMS_OF_SERVICE = 18;
    ACTION_TYPE_OUTWAY_DELETE = 19;
  }

  message Service {
    Organization organization = 1;
    string service = 2;
  }

  uint64 id = 1;
  ActionType action = 2;
  string operatingSystem = 3;
  string browser = 4;
  string client = 5;
  string user = 6;
  repeated Service services = 7;
  google.protobuf.Timestamp createdAt = 8;
  AuditLogRecordMetadata data = 9;
}

message AuditLogRecordMetadata {
  Organization delegatee = 1;
  Organization delegator = 2;
  string reference = 3;
  string inwayName = 4;
  string outwayName = 5;
}

message ListAuditLogsResponse {
  repeated AuditLogRecord auditLogs = 1;
}

message CreateOutgoingOrderRequest {
  string reference = 1;
  string description = 2;
  string publicKeyPEM = 3;
  string delegatee = 4;
  google.protobuf.Timestamp validFrom = 5;
  google.protobuf.Timestamp validUntil = 6;
  repeated uint64 accessProofIds = 7;
}

message UpdateOutgoingOrderRequest {
    string reference = 1;
    string description = 2;
    string publicKeyPEM = 3;
    string delegatee = 4;
    google.protobuf.Timestamp validFrom = 5;
    google.protobuf.Timestamp validUntil = 6;
    repeated uint64 accessProofIds = 7;
}

message RevokeOutgoingOrderRequest{
  string delegatee = 1;
  string reference = 2;
}

message OrderService {
  Organization organization = 1;
  string service = 2;
}

message OutgoingOrder {
  string reference = 1;
  string description = 2;
  Organization delegatee = 4;
  google.protobuf.Timestamp validFrom = 5;
  google.protobuf.Timestamp validUntil = 6;
  repeated AccessProof accessProofs = 7;
  google.protobuf.Timestamp revokedAt = 8;
  string publicKeyPem = 9;
}

message ListOutgoingOrdersResponse {
  repeated OutgoingOrder orders = 1;
}

message IncomingOrder {
  string reference = 1;
  string description = 2;
  Organization delegator = 3;
  google.protobuf.Timestamp valid_from = 4;
  google.protobuf.Timestamp valid_until = 5;
  repeated OrderService services = 6;
  google.protobuf.Timestamp revoked_at = 7;
}

message ListIncomingOrdersResponse {
  repeated IncomingOrder orders = 1;
}

message SynchronizeOutgoingAccessRequestsRequest {
    string organizationSerialNumber = 1;
    string serviceName = 2;
}

service TXLog {
  rpc ListRecords (google.protobuf.Empty) returns (TXLogListRecordsResponse) {
    option (google.api.http) = {get: "/api/v1/txlog/records"};
  }
}

enum TXLogDirection {
  IN = 0;
  OUT = 1;
}

message TXLogOrganization {
  string serialNumber = 1;
  string name = 2;
}

message TXLogService {
  string name = 1;
}

message TXLogOrder {
  TXLogOrganization delegator = 1;
  string reference = 2;
}

message TXLogRecord {
  TXLogOrganization source = 1;
  TXLogOrganization destination = 2;

  TXLogDirection direction = 3;
  TXLogService service = 4;
  string data = 5;
  TXLogOrder order = 6;

  string TransactionID = 7;

  google.protobuf.Timestamp createdAt = 9;
}

message TXLogListRecordsResponse {
  repeated TXLogRecord records = 1;
}

message GetTermsOfServiceStatusResponse {
  bool accepted = 1;
}
