# Copyright Â© VNG Realisatie 2020
# Licensed under the EUPL

# This file contains startup commands for the backends of 3 parts of the NLX landscape.
# - NLX
# - Organization nlx-test
# - Organization nlx-test-b
#
# Organization nlx-test is configured with the NLX Management
# Organization nlx-test-b only consists of an inway with a config file

**/*.go !**/*_test.go {
########################################################################################################################
# NLX
########################################################################################################################

    daemon +sigterm: "# directory-inspection-api
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        directory-inspection-api/cmd/nlx-directory-inspection-api/*.go \
        --listen-address-plain=localhost:6010 \
        --listen-address=localhost:6011 \
        --postgres-dsn='postgresql://postgres:postgres\@localhost/directory?sslmode=disable' \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-directory-cert=testing/pki/org-nlx-test-chain.pem \
        --tls-directory-key=testing/pki/org-nlx-test-key.pem
    "

    daemon +sigterm: "# directory-registration-api
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        directory-registration-api/cmd/nlx-directory-registration-api/*.go \
        --listen-address=localhost:6012 \
        --postgres-dsn='postgresql://postgres:postgres\@localhost/directory?sslmode=disable' \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-directory-cert=testing/pki/org-nlx-test-chain.pem \
        --tls-directory-key=testing/pki/org-nlx-test-key.pem
    "

    daemon +sigterm: "# directory-monitor
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        directory-monitor/cmd/nlx-directory-monitor/*.go \
        --postgres-dsn='postgresql://postgres:postgres\@localhost/directory?sslmode=disable' \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-monitor-cert=testing/pki/org-nlx-test-chain.pem \
        --tls-monitor-key=testing/pki/org-nlx-test-key.pem \
        --ttl-offline-service=30
    "

########################################################################################################################
# Organization A
########################################################################################################################

    daemon +sigterm: "# outway
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        outway/cmd/nlx-outway/*.go \
        --listen-address=localhost:6014 \
        --monitoring-address=localhost:7014 \
        --postgres-dsn='postgresql://postgres:postgres\@localhost/txlog?sslmode=disable' \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-org-cert=testing/pki/org-nlx-test-chain.pem \
        --tls-org-key=testing/pki/org-nlx-test-key.pem \
        --directory-inspection-address=localhost:6011
    "

    daemon +sigterm: "# inway 2
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        inway/cmd/nlx-inway/*.go \
        --listen-address=localhost:6016 \
        --monitoring-address=localhost:7016 \
        --postgres-dsn='postgresql://postgres:postgres\@localhost/txlog?sslmode=disable' \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-org-cert=testing/pki/org-nlx-test-chain.pem \
        --tls-org-key=testing/pki/org-nlx-test-key.pem \
        --self-address=localhost:6016 \
        --directory-registration-address=localhost:6012 \
        --name=inway2 \
        --management-api-address=localhost:6018
    "

    daemon +sigterm: "# management-api
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        management-api/cmd/nlx-management-api/*.go \
        --listen-address=localhost:6017 \
        --config-listen-address=localhost:6018 \
        --etcd-connection-string=http://localhost:2379 \
        --directory-registration-address=localhost:6012 \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-org-cert=testing/pki/org-nlx-test-chain.pem \
        --tls-org-key=testing/pki/org-nlx-test-key.pem \
        --secret-key=V4KMJC8MPL4fe9jtdCAX \
        --oidc-client-id=management \
        --oidc-client-secret=ZXhhbXBsZS1hcHAtc2VjcmV0 \
        --oidc-discovery-url=http://localhost:5556 \
        --oidc-redirect-url=http://localhost:3002/oidc/callback \
        --directory-endpoint-url=http://localhost:6010/api
    "

########################################################################################################################
# Organization B
########################################################################################################################

    daemon +sigterm: "# inway 1
    go run \
        -ldflags='-X go.nlx.io/nlx/common/version.BuildSourceHash=dev -X go.nlx.io/nlx/common/version.BuildVersion=dev' \
        inway/cmd/nlx-inway/*.go \
        --listen-address=localhost:6015 \
        --monitoring-address=localhost:7015 \
        --postgres-dsn='postgresql://postgres:postgres\@localhost/txlog?sslmode=disable' \
        --tls-nlx-root-cert=testing/pki/ca-root.pem \
        --tls-org-cert=testing/pki/org-nlx-test-b-chain.pem \
        --tls-org-key=testing/pki/org-nlx-test-b-key.pem \
        --self-address=localhost:6015 \
        --directory-registration-address=localhost:6012 \
        --service-config=inway/service-config.toml
    "
}
